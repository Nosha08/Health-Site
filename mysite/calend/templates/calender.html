{% extends 'base.html' %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://kit.fontawesome.com/3d9e9bf06e.js" crossorigin="anonymous"></script>

</head>
<p>
    {% if duplicate %}
    <p class = "error" style = "color:red">Error: This timeslot is already taken due to a refresh error. Please go back and refresh your page.</p>
    <button id = "duplicate_btn" onclick = "history.back()">Back</a></button>
    {% else %}
    {% if submitted %}
    <p>Your appointment was created sucessfully!</p>
    <button id = "submitted_btn"><a id = "submitted_link" href = "/../medical/home">Home</a></button>

    {% else %}
    <center>
    <div id = "calender">
    <div class="box calendar">
        <i class="higher left fa-light fa-less-than fa-2xl" onclick = "back()"></i>
        <i class="higher right fa-light fa-greater-than fa-2xl" onclick = "next()"></i>
        {{ cal|safe }}
    </div>
    </div>


    <form id = "appointment_form" action = "" method = POST>
        {% csrf_token %}
        {{ form.date.as_hidden }}
        {{ form.time.as_hidden }}
        {{ form.day.as_hidden }}
        {{ form.month.as_hidden }}
        {{ form.year.as_hidden }}
        {{ form.office_id.as_hidden }}
        {% for i in time_options %}
            {% if i in times %}
                <button class="button2" id="#buttonDis" type = "button" onclick = "time_set('{{ i }}')" id = "{{ i }}" disabled>{{ i }}</button>
            {% else %}
                <button class="button1" id="#buttonNorm" type = "button" onclick = "time_set('{{ i }}')" id = "{{ i }}">{{ i }}</button>
            {% endif %}
        {% endfor %}
        <br>
        <button class="submit-button3" type = "button" onclick = "submit_form()">Submit</button>
        <p id = "errors"></p>
    </form>

    

    {% endif %}

    {% if form.errors  %}
        {{ error }}
    {% endif %}

</center>


    <style>
        .error {
            color: rgb(152, 181, 235);
            font-size: 24px;
            margin-top: 10px;
            font-weight: bolder;
        }

        .left {
            margin-right: 45%;
            display: inline-block;
        }

        .right {
            margin-left: 45%;
            display: inline-block;
        }


        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@100;200;300;400;500;600;700&display=swap');
        
        :root {
            --calendar-bg-color: #262829;
            --calendar-font-color: #FFF;
            --weekdays-border-bottom-color: #404040;
            --calendar-date-hover-color: #505050;
            --calendar-current-date-color: #1b1f21;
            --calendar-today-color: linear-gradient(to bottom, #03a9f4, #2196f3);
            --calendar-today-innerborder-color: transparent;
            --calendar-nextprev-bg-color: transparent;
            --next-prev-arrow-color : #FFF;
            --calendar-border-radius: 16px;
            --calendar-prevnext-date-color: #484848
        }

        .calendar {
            font-family: 'IBM Plex Sans', sans-serif;
            position: relative;
            max-width: 768px; /*change as per your design need */
            min-width: 320px;
            background: var(--calendar-bg-color);
            color: var(--calendar-font-color);
            box-sizing: border-box;
            overflow: hidden;
            font-weight: normal;
            border-radius: var(--calendar-border-radius);
            padding: 100px;
        }

        .calendar-inner {
            padding: 20px 20px;
        }

        .calendar .calendar-inner .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
        }

        .calendar .calendar-inner .calendar-body div {
            padding: 400px;
            min-height: 30px;
            line-height: 30px;
            border: 1px solid transparent;
            margin: 10px 2px 0px;
        }

        .calendar .calendar-inner .calendar-body div:nth-child(-n+7) {
            border: 1px solid transparent;
            border-bottom: 1px solid var(--weekdays-border-bottom-color);
        }

        .calendar .calendar-inner .calendar-body div:nth-child(-n+7):hover {
            border: 1px solid transparent;
            border-bottom: 1px solid var(--weekdays-border-bottom-color);
        }

        .calendar .calendar-inner .calendar-body div>a {
            color: var(--calendar-font-color);
            text-decoration: none;
            display: flex;
            justify-content: center;
        }

        .calendar .calendar-inner .calendar-body div:hover {
            border: 1px solid var(--calendar-date-hover-color);
            border-radius: 4px;
        }

        .calendar .calendar-inner .calendar-body div.empty-dates:hover {
            border: 1px solid transparent;
        }

        .calendar .calendar-inner .calendar-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
        }

        .calendar .calendar-inner .calendar-today-date {
            display: grid;
            text-align: center;
            cursor: pointer;
            margin: 3px 0px;
            background: var(--calendar-current-date-color);
            padding: 8px 0px;
            border-radius: 10px;
            width: 80%;
            margin: auto;
        }

        .calendar .calendar-inner .calendar-controls .calendar-year-month {
            display: flex;
            min-width: 100px;
            justify-content: space-evenly;
            align-items: center;
        }

        .calendar .calendar-inner .calendar-controls .calendar-next {
            text-align: center;
        }

        .calendar .calendar-inner .calendar-controls .calendar-year-month .calendar-year-label,
        .calendar .calendar-inner .calendar-controls .calendar-year-month .calendar-month-label {
            font-weight: 500;
            font-size: 25px;
        }

        .calendar .calendar-inner .calendar-body .calendar-today {
            background: var(--calendar-today-color);
            border-radius: 4px;
        }

        .calendar .calendar-inner .calendar-body .calendar-today:hover {
            border: 1px solid transparent;
        }

        .calendar .calendar-inner .calendar-body .calendar-today a {
            outline: 2px solid var(--calendar-today-innerborder-color);
        }

        .calendar .calendar-inner .calendar-controls .calendar-next a,
        .calendar .calendar-inner .calendar-controls .calendar-prev a {
            color: var(--calendar-font-color);
            font-family: arial, consolas, sans-serif;
            font-size: 6px;
            text-decoration: none;
            padding: 4px 12px;
            display: inline-block;
            background: var(--calendar-nextprev-bg-color);
            margin: 10px 0 10px 0;
        }

        .calendar .calendar-inner .calendar-controls .calendar-next a svg,
        .calendar .calendar-inner .calendar-controls .calendar-prev a svg {
            height: 20px;
            width: 20px;
        }

        .calendar .calendar-inner .calendar-controls .calendar-next a svg path,
        .calendar .calendar-inner .calendar-controls .calendar-prev a svg path{
            fill: var(--next-prev-arrow-color);
        }

        .calendar .calendar-inner .calendar-body .prev-dates,
        .calendar .calendar-inner .calendar-body .next-dates {
            color: var(--calendar-prevnext-date-color);
        }

        .calendar .calendar-inner .calendar-body .prev-dates:hover,
        .calendar .calendar-inner .calendar-body .next-dates:hover {
            border: 1px solid transparent;
            pointer-events: none;
        }

        .selected-day {
            color: green;
            font-weight: bolder;
        }

        .no-slots {
            color: red;
            font-weight: bolder;
        }

        .past-day {
            color: red;
            font-weight: bolder;
        }

        td {
            padding: 30px;
            margin: 10px;
        }

        #buttonNorm {
            margin: 5px;
        }

        #buttonDis {
            margin: 5px;
        }

    </style>
{% endif %}

    <script>
        
        var calender = document.getElementById("calender")
        var month = "{{ month }}"
        var year = parseInt("{{ year }}")
        var month_number = parseInt("{{ month_number }}")
        var day = parseInt("{{ day }}")
        var full_date = [year, month_number, day].join('-');    
        var times_len = parseInt("{{ times_len }}")
        var filled = {{ filled }}
        var none_left = "False"
        var last_day = 0
        var office_id = parseInt({{office_id}})
        document.getElementById("id_date").value = full_date
        document.getElementById("id_day").value = day
        document.getElementById("id_month").value = month_number
        document.getElementById("id_year").value = year
        document.getElementById("id_office_id").value = office_id
        $("td:contains(" + CSS.escape(day) + "):first").addClass("selected")

        function cancel_days(){
            for(i=0;i<filled.length;i++){
                if(filled[i] >= {{times_len}}){
                    $("td:contains(" + CSS.escape(i) + "):first").addClass("filled");
                    if(day == i){
                        none_left = "True"
                    }
                }
            }
        }
        cancel_days()
        function submit_form(){
            if(document.getElementById("id_time").value != ""){
                document.getElementById("appointment_form").submit()
                document.getElementById("id_month").value = month
                document.getElementById("id_year").value = year
                document.getElementById("id_day").value = day
            }else{
                if(none_left == "False"){
                document.getElementById("errors").innerHTML = "Please select a Time"
                }else{
                    document.getElementById("errors").innerHTML = "This day is complely booked, please choose another one."
                }
            }
        }


        function fetch_data(e){
            let day = e.target.innerHTML
            
            if (Number.isInteger(parseInt(day))){
                window.location.replace("/calendar/calender/"+ office_id + "/" + year + "/" + month + "/" + day + "/");
            }
        }
        //add classes to every number. That way we can add cursor hover property
        for(i=0; i<32; i++){
            $("td:contains(" + CSS.escape(i) + ")").addClass("calender-td")


        }
        //$('table').on('click', 'td', fetch_data())
        calender.addEventListener('click', fetch_data, false)
        months = {
                "January":1,
                "February":2,
                "March":3,
                "April":4,
                "May":5,
                "June":6,
                "July":7,
                "August":8,
                "September":9,
                "October":10,
                "November":11,
                "December":12
            }

                var calender_td = document.getElementsByClassName("calender-td")
                last_day = calender_td[(calender_td.length-1)].innerHTML


                function next(){
                    months = {
                        "January":1,
                        "February":2,
                        "March":3,
                        "April":4,
                        "May":5,
                        "June":6,
                        "July":7,
                        "August":8,
                        "September":9,
                        "October":10,
                        "November":11,
                        "December":12
                    }
                    if(month_number == 12){
                        year = parseInt(year)
                        month_number = 1;
                        year++;
                    } else {
                        month_number++;
                    }
                    for (val of Object.keys(months)) {
                        if(months[val] == month_number){
                            month = val
                        }
                    }
                    //month
                    window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/");
                }

                function back(){
                    months = {
                        "January":1,
                        "February":2,
                        "March":3,
                        "April":4,
                        "May":5,
                        "June":6,
                        "July":7,
                        "August":8,
                        "September":9,
                        "October":10,
                        "November":11,
                        "December":12
                    }
                    if(month_number == 1){
                        year = parseInt(year)
                        month_number = 12;
                        year--;
                    } else {
                        month_number--;
                    }
                    for (val of Object.keys(months)) {
                        if(months[val] == month_number){
                            month = val
                        }
        }
                    //month
                    window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/");
                }
        var old_id = "None";
        function time_set(time){
            document.getElementById("id_time").value = time

            if (old_id != "None"){
                //alert(old_id)
                document.getElementById(old_id).classList.remove("selected_time")
            }
            old_id = time
            document.getElementById(time).classList.add("selected_time")
        }

        window.addEventListener('keydown', function (e) { 
            if(e.keyCode == 37){
                //left
                if (day != 1){
                window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) - 1) + "/");
                }
            }else if(e.keyCode == 39){
                if(day != last_day){
                    //right
                    window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) + 1) + "/");
                }
            }else if(e.keyCode == 38){
                //up
                if(day > 7){
                    window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) - 7) + "/");
                }
            }else if(e.keyCode == 40){
                //down
                if(day < (last_day-6)){
                    window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) + 7) + "/");
                }
            }else if(e.keyCode == 13){
                submit_form()
            }
        }, false);

        function fetch_data(e) {
                let day = e.target.innerHTML;
                if (Number.isInteger(parseInt(day))) {
                    // Remove the "selected-day" class from all elements with class "Calender-td"
                    let calender_td = document.getElementsByClassName("calender-td");
                    for (let i = 0; i < calender_td.length; i++) {
                        calender_td[i].classList.remove("selected-day");
                    }

                    // Add the "selected-day" class to the selected day
                    e.target.classList.add("selected-day");

                    // Store the selected day in localStorage
                    localStorage.setItem("selectedDay", day);

                    // Construct the new URL with the selected day and navigate to it
                    let newUrl = `/calendar/calender/${office_id}/${year}/${month}/${day}/`;
                    window.location.href = newUrl;
                }
            }

            // Call the function when the page loads to set the selected day if it's available in localStorage
            window.addEventListener("load", function () {
                let selectedDay = localStorage.getItem("selectedDay");
                if (selectedDay) {
                    let calender_td = document.getElementsByClassName("calender-td");
                    for (let i = 0; i < calender_td.length; i++) {
                        if (calender_td[i].innerHTML === selectedDay) {
                            calender_td[i].classList.add("selected-day");
                            break;
                        }
                    }
                }
            });

            // ... (existing code) ...

            function selectDay(dayNumber) {
                let calender_td = document.getElementsByClassName("calender-td");
                for (let i = 0; i < calender_td.length; i++) {
                    if (calender_td[i].innerHTML === dayNumber.toString()) {
                        calender_td[i].classList.add("selected-day");
                    } else {
                        calender_td[i].classList.remove("selected-day");
                    }
                }
            }

            window.addEventListener("keydown", function (e) {
                if (e.keyCode === 37) {
                    // Left arrow key
                    let prevDay = parseInt(localStorage.getItem("selectedDay")) - 1;
                    if (prevDay >= 1) {
                        selectDay(prevDay);
                        localStorage.setItem("selectedDay", prevDay);
                        e.preventDefault(); // Prevent the default behavior of arrow keys scrolling the page
                    }
                } else if (e.keyCode === 39) {
                    // Right arrow key
                    let nextDay = parseInt(localStorage.getItem("selectedDay")) + 1;
                    if (nextDay <= last_day) {
                        selectDay(nextDay);
                        localStorage.setItem("selectedDay", nextDay);
                        e.preventDefault(); // Prevent the default behavior of arrow keys scrolling the page
                    }
                } else if (e.keyCode === 38) {
                    // Up arrow key
                    let prevWeekDay = parseInt(localStorage.getItem("selectedDay")) - 7;
                    if (prevWeekDay >= 1) {
                        selectDay(prevWeekDay);
                        localStorage.setItem("selectedDay", prevWeekDay);
                        e.preventDefault(); // Prevent the default behavior of arrow keys scrolling the page
                    }
                } else if (e.keyCode === 40) {
                    // Down arrow key
                    let nextWeekDay = parseInt(localStorage.getItem("selectedDay")) + 7;
                    if (nextWeekDay <= last_day) {
                        selectDay(nextWeekDay);
                        localStorage.setItem("selectedDay", nextWeekDay);
                        e.preventDefault(); // Prevent the default behavior of arrow keys scrolling the page
                    }
                }
            });

            function toggleButtonState(button) {
        button.classList.toggle("active");
        }

        function submit_form() {
        const selectedTime = document.getElementById("id_time").value;
        const errorsElement = document.getElementById("errors");

        if (selectedTime) {
            errorsElement.textContent = ""; // Clear any previous error message
            document.getElementById("appointment_form").submit();
            document.getElementById("id_month").value = month;
            document.getElementById("id_year").value = year;
            document.getElementById("id_day").value = day;
        } else {
            errorsElement.textContent = "Please select a time...";
            errorsElement.classList.add("error");
        }
        }

        function cancel_days() {
            const errorsElement = document.getElementById("errors");
            for (i = 0; i < filled.length; i++) {
            if (filled[i] >= times_len) {
                $("td:contains(" + CSS.escape(i) + "):first").addClass("filled");
                if (day == i) {
                none_left = "True";
                // If all time slots are taken for this day, add the "no-slots" class to the corresponding td element
                $("td:contains(" + CSS.escape(i) + "):first").addClass("no-slots");
                errorsElement.textContent = "Please select a day with open time slots...";
                errorsElement.classList.add("error");
                }
            }
            // If all time slots are taken for a day, add the "no-slots" class to the corresponding td element
            if (filled[i] >= times_len) {
                $("td:contains(" + CSS.escape(i) + "):first").addClass("no-slots");
            }
            }

            // Add the "past-day" class to days before today's date
            let today = new Date().getDate();
            $("td:lt(" + (today - 1) + ")").addClass("past-day");
        }

        
            // ... (existing code) ...

            // Function to check if a date is in the past
            function isPastDay(year, month, day) {
                const today = new Date();
                const errorsElement = document.getElementById("errors");
                const inputDate = new Date(year, month - 1, day); // Note: JavaScript months are 0-indexed (0-11)
                return inputDate < today;
            }

            function preventPastSelect(year, month, day) {
                const yearNumber = parseInt(year);
                const monthNumber = months[month];
                const today = new Date();
                const selectedDate = new Date(yearNumber, monthNumber - 1, day);

                const buttonNorm = document.getElementById("buttonNorm");

                if (selectedDate < today) {
                    buttonNorm.classList.remove("button1");
                    buttonNorm.classList.add("button2");
                } else {
                    buttonNorm.classList.remove("button2");
                    buttonNorm.classList.add("button1");
                }
            }

            // Function to apply styles to the calendar days
            function applyCalendarStyles() {
                const errorsElement = document.getElementById("errors");
                const calender_td = document.getElementsByClassName("calender-td");
                for (let i = 0; i < calender_td.length; i++) {
                    const dayNumber = parseInt(calender_td[i].innerHTML);
                    if (isNaN(dayNumber)) {
                        continue; // Skip non-number elements
                    }

                    if (dayNumber === day) {
                        calender_td[i].classList.add("selected-day");
                    } else {
                        calender_td[i].classList.remove("selected-day");
                    }

                    // Check if the day is in the past and add the "past-day" class
                    const yearNumber = parseInt(year);
                    const monthNumber = parseInt(months[month]);
                    if (isPastDay(yearNumber, monthNumber, dayNumber)) {
                        calender_td[i].classList.add("past-day");
                        errorsElement.textContent = "Please do not select past days...";
                        errorsElement.classList.add("error");
                    } else {
                        calender_td[i].classList.remove("past-day");
                    }
                }
            }

            // Call the function when the page loads to set the selected day if it's available in localStorage
            window.addEventListener("load", function () {
                const selectedDay = localStorage.getItem("selectedDay");
                if (selectedDay) {
                    selectDay(parseInt(selectedDay));
                }
                applyCalendarStyles(); // Apply styles when the page loads
            });
                
            
    </script>

</body>
</html>

{% endblock %}