{% extends 'base.html' %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<p>
    {% if duplicate %}
    <p class = "error" style = "color:red">Error: This timeslot is already taken due to a refresh error. Please go back and refresh your page.</p>
    <button id = "duplicate_btn" onclick = "history.back()">Back</a></button>
    {% else %}
    {% if submitted %}
    <p>Your appointment was created sucessfully!</p>
    <button id = "submitted_btn"><a id = "submitted_link" href = "/../medical/home">Home</a></button>

    {% else %}
    <center>
    <h1>Hello. Events for {{ month }} {{ year }}</h1>
    <div id = "calender">
        <button onclick = "back()">Back</button>
        <button onclick = "next()">Next</button>
    {{ cal|safe }}
    </div>
    </center>


    <h1>Make an Appointment</h1>
    <form id = "appointment_form" action = "" method = POST>
        {% csrf_token %}
        {{ form.date.as_hidden }}
        {{ form.time.as_hidden }}
        {{ form.day.as_hidden }}
        {{ form.month.as_hidden }}
        {{ form.year.as_hidden }}
        {{ form.office_id.as_hidden }}
        {% for i in time_options %}
        {% if i in times %}
        <button class = "booked_time" type = "button" onclick = "time_set('{{ i }}')" id = "{{ i }}" disabled>{{ i }}</button>
        {% else %}
        <button type = "button" onclick = "time_set('{{ i }}')" id = "{{ i }}">{{ i }}</button>
        {% endif %}
        {% endfor %}
        <button class="submit-button3" type = "button" onclick = "submit_form()">Submit</button>
        <p id = "errors"></p>
    </form>

    {% endif %}

    <style>
        td{
            padding:28px
        }
        .red{
            color:red
        }
        .Calender-td:hover{
            cursor:pointer
        }
        table, .Calender-td{
            border: 2px solid black;
            border-collapse: collapse
        }
        .selected{
            background-color: darkslategrey;
            color:white;
            font-weight: bold;
        }
        #errors{
            color:red;
        }
        .filled{
            background-color: red;
            color:white
        }
        .selected_time{
            background-color: cornflowerblue !important;
        }
        .filled.selected{
            background-color: rgb(255, 136, 0);
            color:white;
            font-weight: bold;
        }
    </style>
{% endif %}
    <script>
        var calender = document.getElementById("calender")
        var month = "{{ month }}"
        var year = parseInt("{{ year }}")
        var month_number = parseInt("{{ month_number }}")
        var day = parseInt("{{ day }}")
        var full_date = [year, month_number, day].join('-');    
        var times_len = parseInt("{{ times_len }}")
        var filled = {{ filled }}
        var none_left = "False"
        var last_day = 0
        var office_id = parseInt({{office_id}})
        document.getElementById("id_date").value = full_date
        document.getElementById("id_day").value = day
        document.getElementById("id_month").value = month_number
        document.getElementById("id_year").value = year
        document.getElementById("id_office_id").value = office_id
        $("td:contains(" + CSS.escape(day) + "):first").addClass("selected")

        function cancel_days(){
            for(i=0;i<filled.length;i++){
                if(filled[i] >= {{times_len}}){
                    $("td:contains(" + CSS.escape(i) + "):first").addClass("filled");
                    if(day == i){
                        none_left = "True"
                    }
                }
            }
        }
        cancel_days()
        function submit_form(){
            if(document.getElementById("id_time").value != ""){
                document.getElementById("appointment_form").submit()
                document.getElementById("id_month").value = month
                document.getElementById("id_year").value = year
                document.getElementById("id_day").value = day
            }else{
                if(none_left == "False"){
                document.getElementById("errors").innerHTML = "Please select a Time"
                }else{
                    document.getElementById("errors").innerHTML = "This day is complely booked, please choose another one."
                }
            }
        }


        function fetch_data(e){
            let day = e.target.innerHTML
            
            if (Number.isInteger(parseInt(day))){
                window.location.replace("/calendar/calender/"+ office_id + "/" + year + "/" + month + "/" + day + "/");
            }
        }
        //add classes to every number. That way we can add cursor hover property
        for(i=0; i<32; i++){
            $("td:contains(" + CSS.escape(i) + ")").addClass("Calender-td")

        }
//$('table').on('click', 'td', fetch_data())
calender.addEventListener('click', fetch_data, false)
months = {
        "January":1,
        "February":2,
        "March":3,
        "April":4,
        "May":5,
        "June":6,
        "July":7,
        "August":8,
        "September":9,
        "October":10,
        "November":11,
        "December":12
    }

        var calender_td = document.getElementsByClassName("Calender-td")
        last_day = calender_td[(calender_td.length-1)].innerHTML


        function next(){
            if(month_number == 12){
                year = parseInt(year)
                month_number = 1;
                year++;
            } else {
                month_number++;
            }
            for (val of Object.keys(months)) {
                if(months[val] == month_number){
                    month = val
                }
}
            //month
            window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/");
        }

        function back(){
            if(month_number == 1){
                year = parseInt(year)
                month_number = 12;
                year--;
            } else {
                month_number--;
            }
            for (val of Object.keys(months)) {
                if(months[val] == month_number){
                    month = val
                }
}
            //month
            window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/");
        }
var old_id = "None";
function time_set(time){
    document.getElementById("id_time").value = time

    if (old_id != "None"){
        //alert(old_id)
        document.getElementById(old_id).classList.remove("selected_time")
    }
    old_id = time
    document.getElementById(time).classList.add("selected_time")
}

window.addEventListener('keydown', function (e) { 
    if(e.keyCode == 37){
        //left
        if (day != 1){
        window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) - 1) + "/");
        }
    }else if(e.keyCode == 39){
        if(day != last_day){
            //right
            window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) + 1) + "/");
        }
    }else if(e.keyCode == 38){
        //up
        if(day > 7){
            window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) - 7) + "/");
        }
    }else if(e.keyCode == 40){
        //down
        if(day < (last_day-6)){
            window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) + 7) + "/");
        }
    }else if(e.keyCode == 13){
        submit_form()
    }
}, false);
    </script>

</body>
</html>

{% endblock %}