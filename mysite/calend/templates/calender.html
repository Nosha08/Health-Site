{% extends 'base.html' %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<p>
    {% if duplicate %}
    <p class = "error" style = "color:red">Error: This timeslot is already taken due to a refresh error. Please go back and refresh your page.</p>
    <button id = "duplicate_btn" onclick = "history.back()">Back</a></button>
    {% else %}
    {% if submitted %}
    <p>Your appointment was created sucessfully!</p>
    <button id = "submitted_btn"><a id = "submitted_link" href = "/../medical/home">Home</a></button>

    {% else %}
    <center>
    <div id = "calender">
        <button class="arrow" onclick = "back()">Back</button>
        <button onclick = "next()">Next</button>
    <div class="box calendar">
        {{ cal|safe }}
    </div>
    </div>


    <form id = "appointment_form" action = "" method = POST>
        {% csrf_token %}
        {{ form.date.as_hidden }}
        {{ form.time.as_hidden }}
        {{ form.day.as_hidden }}
        {{ form.month.as_hidden }}
        {{ form.year.as_hidden }}
        {{ form.office_id.as_hidden }}
        {% for i in time_options %}
            {% if i in times %}
                <button class = "booked_time" type = "button" onclick = "time_set('{{ i }}')" id = "{{ i }}" disabled>{{ i }}</button>
            {% else %}
                <button class="button1" type = "button" onclick = "time_set('{{ i }}')" id = "{{ i }}">{{ i }}</button>
            {% endif %}
        {% endfor %}
        <button class="submit-button3" type = "button" onclick = "submit_form()">Submit</button>
        <p id = "errors"></p>
    </form>
</center>
    {% endif %}

    <style>

        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@100;200;300;400;500;600;700&display=swap');

        :root {
            --calendar-bg-color: #262829;
            --calendar-font-color: #FFF;
            --weekdays-border-bottom-color: #404040;
            --calendar-date-hover-color: #505050;
            --calendar-current-date-color: #1b1f21;
            --calendar-today-color: linear-gradient(to bottom, #03a9f4, #2196f3);
            --calendar-today-innerborder-color: transparent;
            --calendar-nextprev-bg-color: transparent;
            --next-prev-arrow-color : #FFF;
            --calendar-border-radius: 16px;
            --calendar-prevnext-date-color: #484848
        }

        * {
            padding: 20px;
            margin: 0;
            margin-top: -28px;
        }

        .calendar {
            font-family: 'IBM Plex Sans', sans-serif;
            position: relative;
            max-width: 768px; /*change as per your design need */
            min-width: 320px;
            background: var(--calendar-bg-color);
            color: var(--calendar-font-color);
            margin: 20px auto;
            box-sizing: border-box;
            overflow: hidden;
            font-weight: normal;
            border-radius: var(--calendar-border-radius);
        }

        .calendar-inner {
            padding: 10px 10px;
        }

        .calendar .calendar-inner .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
        }

        .calendar .calendar-inner .calendar-body div {
            padding: 4px;
            min-height: 30px;
            line-height: 30px;
            border: 1px solid transparent;
            margin: 10px 2px 0px;
        }

        .calendar .calendar-inner .calendar-body div:nth-child(-n+7) {
            border: 1px solid transparent;
            border-bottom: 1px solid var(--weekdays-border-bottom-color);
        }

        .calendar .calendar-inner .calendar-body div:nth-child(-n+7):hover {
            border: 1px solid transparent;
            border-bottom: 1px solid var(--weekdays-border-bottom-color);
        }

        .calendar .calendar-inner .calendar-body div>a {
            color: var(--calendar-font-color);
            text-decoration: none;
            display: flex;
            justify-content: center;
        }

        .calendar .calendar-inner .calendar-body div:hover {
            border: 1px solid var(--calendar-date-hover-color);
            border-radius: 4px;
        }

        .calendar .calendar-inner .calendar-body div.empty-dates:hover {
            border: 1px solid transparent;
        }

        .calendar .calendar-inner .calendar-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
        }

        .calendar .calendar-inner .calendar-today-date {
            display: grid;
            text-align: center;
            cursor: pointer;
            margin: 3px 0px;
            background: var(--calendar-current-date-color);
            padding: 8px 0px;
            border-radius: 10px;
            width: 80%;
            margin: auto;
        }

        .calendar .calendar-inner .calendar-controls .calendar-year-month {
            display: flex;
            min-width: 100px;
            justify-content: space-evenly;
            align-items: center;
        }

        .calendar .calendar-inner .calendar-controls .calendar-next {
            text-align: center;
        }

        .calendar .calendar-inner .calendar-controls .calendar-year-month .calendar-year-label,
        .calendar .calendar-inner .calendar-controls .calendar-year-month .calendar-month-label {
            font-weight: 500;
            font-size: 20px;
        }

        .calendar .calendar-inner .calendar-body .calendar-today {
            background: var(--calendar-today-color);
            border-radius: 4px;
        }

        .calendar .calendar-inner .calendar-body .calendar-today:hover {
            border: 1px solid transparent;
        }

        .calendar .calendar-inner .calendar-body .calendar-today a {
            outline: 2px solid var(--calendar-today-innerborder-color);
        }

        .calendar .calendar-inner .calendar-controls .calendar-next a,
        .calendar .calendar-inner .calendar-controls .calendar-prev a {
            color: var(--calendar-font-color);
            font-family: arial, consolas, sans-serif;
            font-size: 6px;
            text-decoration: none;
            padding: 4px 12px;
            display: inline-block;
            background: var(--calendar-nextprev-bg-color);
            margin: 10px 0 10px 0;
        }

        .calendar .calendar-inner .calendar-controls .calendar-next a svg,
        .calendar .calendar-inner .calendar-controls .calendar-prev a svg {
            height: 20px;
            width: 20px;
        }

        .calendar .calendar-inner .calendar-controls .calendar-next a svg path,
        .calendar .calendar-inner .calendar-controls .calendar-prev a svg path{
            fill: var(--next-prev-arrow-color);
        }

        .calendar .calendar-inner .calendar-body .prev-dates,
        .calendar .calendar-inner .calendar-body .next-dates {
            color: var(--calendar-prevnext-date-color);
        }

        .calendar .calendar-inner .calendar-body .prev-dates:hover,
        .calendar .calendar-inner .calendar-body .next-dates:hover {
        border: 1px solid transparent;
        pointer-events: none;
        }

        .selected-day {
        color: green;
        font-weight: bolder;
        }
    </style>
{% endif %}
    <script>
        var calender = document.getElementById("calender")
        var month = "{{ month }}"
        var year = parseInt("{{ year }}")
        var month_number = parseInt("{{ month_number }}")
        var day = parseInt("{{ day }}")
        var full_date = [year, month_number, day].join('-');    
        var times_len = parseInt("{{ times_len }}")
        var filled = {{ filled }}
        var none_left = "False"
        var last_day = 0
        var office_id = parseInt({{office_id}})
        document.getElementById("id_date").value = full_date
        document.getElementById("id_day").value = day
        document.getElementById("id_month").value = month_number
        document.getElementById("id_year").value = year
        document.getElementById("id_office_id").value = office_id
        $("td:contains(" + CSS.escape(day) + "):first").addClass("selected")

        function cancel_days(){
            for(i=0;i<filled.length;i++){
                if(filled[i] >= {{times_len}}){
                    $("td:contains(" + CSS.escape(i) + "):first").addClass("filled");
                    if(day == i){
                        none_left = "True"
                    }
                }
            }
        }
        cancel_days()
        function submit_form(){
            if(document.getElementById("id_time").value != ""){
                document.getElementById("appointment_form").submit()
                document.getElementById("id_month").value = month
                document.getElementById("id_year").value = year
                document.getElementById("id_day").value = day
            }else{
                if(none_left == "False"){
                document.getElementById("errors").innerHTML = "Please select a Time"
                }else{
                    document.getElementById("errors").innerHTML = "This day is complely booked, please choose another one."
                }
            }
        }


        function fetch_data(e){
            let day = e.target.innerHTML
            
            if (Number.isInteger(parseInt(day))){
                window.location.replace("/calendar/calender/"+ office_id + "/" + year + "/" + month + "/" + day + "/");
            }
        }
        //add classes to every number. That way we can add cursor hover property
        for(i=0; i<32; i++){
            $("td:contains(" + CSS.escape(i) + ")").addClass("Calender-td")

        }
//$('table').on('click', 'td', fetch_data())
calender.addEventListener('click', fetch_data, false)
months = {
        "January":1,
        "February":2,
        "March":3,
        "April":4,
        "May":5,
        "June":6,
        "July":7,
        "August":8,
        "September":9,
        "October":10,
        "November":11,
        "December":12
    }

        var calender_td = document.getElementsByClassName("Calender-td")
        last_day = calender_td[(calender_td.length-1)].innerHTML


        function next(){
            if(month_number == 12){
                year = parseInt(year)
                month_number = 1;
                year++;
            } else {
                month_number++;
            }
            for (val of Object.keys(months)) {
                if(months[val] == month_number){
                    month = val
                }
}
            //month
            window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/");
        }

        function back(){
            if(month_number == 1){
                year = parseInt(year)
                month_number = 12;
                year--;
            } else {
                month_number--;
            }
            for (val of Object.keys(months)) {
                if(months[val] == month_number){
                    month = val
                }
}
            //month
            window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/");
        }
var old_id = "None";
function time_set(time){
    document.getElementById("id_time").value = time

    if (old_id != "None"){
        //alert(old_id)
        document.getElementById(old_id).classList.remove("selected_time")
    }
    old_id = time
    document.getElementById(time).classList.add("selected_time")
}

window.addEventListener('keydown', function (e) { 
    if(e.keyCode == 37){
        //left
        if (day != 1){
        window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) - 1) + "/");
        }
    }else if(e.keyCode == 39){
        if(day != last_day){
            //right
            window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) + 1) + "/");
        }
    }else if(e.keyCode == 38){
        //up
        if(day > 7){
            window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) - 7) + "/");
        }
    }else if(e.keyCode == 40){
        //down
        if(day < (last_day-6)){
            window.location.replace("/calendar/calender/" + office_id + "/" + year + "/" + month + "/" + (parseInt(day) + 7) + "/");
        }
    }else if(e.keyCode == 13){
        submit_form()
    }
}, false);

function fetch_data(e) {
        let day = e.target.innerHTML;

        if (Number.isInteger(parseInt(day))) {
            // Remove the "selected-day" class from all elements with class "Calender-td"
            let calender_td = document.getElementsByClassName("Calender-td");
            for (let i = 0; i < calender_td.length; i++) {
                calender_td[i].classList.remove("selected-day");
            }

            // Add the "selected-day" class to the selected day
            e.target.classList.add("selected-day");

            // Store the selected day in localStorage
            localStorage.setItem("selectedDay", day);

            // Construct the new URL with the selected day and navigate to it
            let newUrl = `/calendar/calender/${office_id}/${year}/${month}/${day}/`;
            window.location.href = newUrl;
        }
    }

    function setSelectedDayGreen() {
        let selectedDay = localStorage.getItem("selectedDay");
        if (selectedDay) {
            let calender_td = document.getElementsByClassName("Calender-td");
            for (let i = 0; i < calender_td.length; i++) {
                if (calender_td[i].innerHTML === selectedDay) {
                    calender_td[i].classList.add("selected-day");
                    break;
                }
            }
        }
    }

    // Call the function when the page loads
    window.addEventListener("load", setSelectedDayGreen);

    </script>

</body>
</html>

{% endblock %}